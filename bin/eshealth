#!/usr/bin/env ruby

require 'optparse'
require 'ostruct'
require 'eshealth'
require 'pp'

options = OpenStruct.new()
options[:url] = "http://localhost:9200"
options[:period] = 5
options[:failures] = 2
options[:condition] = "green"
options[:percentage] = 20

OptionParser.new do |opts|
  opts.banner = "Usage: eshealth [OPTIONS]"
  opts.on("-u http://your_url:9200", "--url=http://your_url:9200", "URL to ES server") do |url|
    options[:url] = url
  end
  opts.on("-p N", "--period=N", "Number of minutes between checks") do |period|
    options[:period] = period.to_i
  end
  opts.on("-f N", "--failures=N", "Number of consecutive failures to trigger an alert") do |failures|
    options[:failures] = failures.to_i
  end
  opts.on("-c STRING", "--condition=STRING", "String matching a successful healthcheck") do |condition|
    options[:condition] = condition
  end
  opts.on("-q N", "--quell=N", "Amount of time to quell between alerts") do |quell|
    options[:quell] = quell.to_i
  end
  opts.on("-k SERVICEKEY", "--key=SERVICEKEY", "PagerDuty service key") do |servicekey|
    options[:servicekey] = servicekey
  end
  opts.on("-n CHECKNAME", "--check=CHECKNAME", "Name of check to perform, default: clusterhealth, options: clusterhealth,clusterconfig,clusterfs") do |check|
    options[:check] = check
  end
  opts.on("--percentage", "Percentage to alert about when the check is a percentage based check (default 20).") do |percentage|
    options[:percentage] = percentage
  end
  opts.on("--alertmethod", "The method to alert default: pagerduty, options: email, pagerduty") do |alertfactory|
    options[:alertfactory] = alertfactory
  end
  opts.on("--from_email", "Email to send alerts from if using email alerts") do |from_email|
    options[:from_email] = from_email
  end
  opts.on("--to_email", "Email to send alerts to if using email alerts") do |to_email|
    options[:to_email] = to_email
  end
  opts.on("--smtp", "SMTP server to send email through if using email alerts (default 'localhost')") do |smtp|
    options[:smtp] = smtp
  end
  opts.on("--user", "Username if needed for notification method") do |user|
    options[:user] = user
  end
  opts.on("--password", "Password if needed for notification method") do |password|
    options[:password] = password
  end
  opts.on("--logintype", "Login type if needed for notification method default: login, options: plain, login, cram_md5 ")
end.parse!

checkfactory = Eshealth::ClusterHealth.new(:url => options[:url])
case options[:check]
when "clusterhealth"
  checkfactory = Eshealth::ClusterHealth.new(:url => options[:url])
when "clusterconfig"
  checkfactory = Eshealth::ClusterConfig.new(:url => options[:url])
when "clusterfs"
  checkfactory = Eshealth::ClusterFS.new(:url => options[:url], :percentage => options[:percentage])
end

alertfactory = Eshealth::PagerDuty.new(:servicekey => options[:servicekey])
case options[:alertfactory]
when "pagerduty"
  alertfactory = Eshealth::PagerDuty.new(:servicekey => options[:servicekey])
when "email"
  alertfactory = Eshealth::PagerDuty.new(
    :from_email => options[:from_email], 
    :to_email   => options[:to_email],
    :smtp       => options[:smtp],
    :port       => options[:port],
    :username   => options[:username],
    :password   => options[:password],
    :logintype  => options[:logintype]
  )
end


checkloop = Eshealth::CheckLoop.new(
  :period         => options[:period],
  :failures       => options[:failures],
  :condition      => options[:condition],
  :quell          => options[:quell],
  :checkfactory   => checkfactory,
  :alertfactory   => Eshealth::PagerDutyAlert.new(:servicekey => options[:servicekey])
)

checkloop.start